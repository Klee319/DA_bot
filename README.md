# Discord アイテム参照BOT

Discord上でCSVデータに基づいたアイテム情報を検索・表示するBOTです。

## 機能

### ✅ 実装済み機能 (All Phases Complete!)

#### Phase 1: 基本機能
- **基本アイテム検索**: 正式名称・一般名称での完全一致検索
- **ワイルドカード検索**: `*`と`?`を使った柔軟な検索
- **表記ゆれ対応**: ひらがな⇔カタカナ、全角⇔半角の自動変換
- **CSV管理機能**: 管理者によるCSVアップロードとデータ更新
- **お気に入り機能**: ユーザーごとのアイテムお気に入り登録
- **検索履歴**: 個人の検索履歴保存（30日間）
- **管理者機能**: 検索統計情報の表示

#### Phase 2: 高度な検索・表示機能
- **ページネーション**: 検索結果の分割表示とアイテム選択メニュー
- **関連アイテム検索**: 素材・制作物・ドロップ元の連携表示
- **複数アイテム同時検索**: 最大3つのアイテムを同時検索

#### Phase 3: UX向上・高度機能
- **画像表示**: 有効な画像URLの自動検証と表示
- **強化された部分一致検索**: 関連性スコアによる結果ソート
- **アイテムリンク機能**: 関連アイテムをクリックで詳細表示
- **インタラクション改善**: 処理中のボタン無効化・タイムアウト延長
- **エラーハンドリング強化**: 分かりやすいエラーメッセージと検索候補提示

## セットアップ

### 1. 依存関係のインストール
```bash
pip install -r requirements.txt
```

### 2. 環境変数の設定
`.env`ファイルを作成し、Discord BOTトークンを設定：
```env
DISCORD_TOKEN=your_bot_token_here
ADMIN_USER_IDS=123456789012345678,987654321098765432
LOG_CHANNEL_ID=123456789012345678
```

### 3. 設定ファイルの確認
`config.json`の管理者設定を確認・更新してください。

### 4. BOTの起動
```bash
python src/main.py
```

## 使用方法

### 基本検索
```
ウッドソード        # 正式名称で検索
木の棒             # 一般名称で検索
ウッド*            # ワイルドカード検索
```

### コマンド
- `!favorites` / `!fav`: お気に入り一覧表示
- `!history`: 検索履歴表示

### 管理者コマンド
- `!upload_csv [type] [file]`: CSVファイルアップロード
  - type: equipment, material, mob, gathering
- `!stats search_ranking`: 検索ランキング表示

## ファイル構造

```
DA_discord/
├── src/                    # ソースコード
│   ├── main.py            # メインBOTファイル
│   ├── database.py        # データベース管理
│   ├── search_engine.py   # 検索エンジン
│   ├── embed_manager.py   # Discord Embed管理
│   └── csv_manager.py     # CSV処理
├── data/                  # データベースファイル
├── backups/              # 自動バックアップ
├── logs/                 # ログファイル
├── sampleCSVdata/        # サンプルCSVデータ
├── ref/                  # 仕様書・設計書
├── config.json           # 設定ファイル
├── requirements.txt      # 依存関係
├── .env.example         # 環境変数サンプル
└── test_bot.py          # テストスクリプト
```

## CSVファイル形式

### Equipment (装備品)
- 正式名称, 一般名称, 入手カテゴリ, 種類, 必要素材, 必要レベル, アイテム効果, 一言, 画像リンク

### Material (素材)
- 正式名称, 一般名称, 入手カテゴリ, 入手方法, 利用カテゴリ, 使用用途, アイテム効果, 一言

### Mob (モンスター)
- 正式名称, 一般名称, 出没エリア, 出没エリア詳細, 必要レベル, ドロップ品, EXP, Gold, 一言

### Gathering (採取)
- 場所, 収集方法, 入手素材, 使用用途, 必要ツール, 一言

## データベース設計

SQLiteを使用し、以下のテーブルで構成：
- `equipments`: 装備品データ
- `materials`: 素材データ
- `mobs`: モンスターデータ
- `gatherings`: 採取データ
- `user_favorites`: ユーザーお気に入り
- `search_history`: 検索履歴
- `search_stats`: 検索統計

## 技術スタック

- **Python**: 3.10以上
- **Discord.py**: 2.3.x
- **SQLite**: データベース
- **pandas**: CSV処理
- **jaconv**: 日本語文字変換
- **aiohttp**: 非同期HTTP処理

## トラブルシューティング

### BOTが起動しない
1. DISCORD_TOKENが正しく設定されているか確認
2. BOTに必要な権限が付与されているか確認
3. `logs/bot.log`でエラーログを確認

### 検索結果が出ない
1. CSVデータが正しくインポートされているか確認
2. テストスクリプトで動作確認：`python test_bot.py`

### CSV アップロードエラー
1. CSVファイルの形式が正しいか確認
2. 必須カラムが存在するか確認
3. 文字エンコーディングがUTF-8か確認

## テスト

```bash
python test_bot.py
```

このスクリプトは以下をテストします：
- データベース初期化
- CSVインポート
- 検索機能
- お気に入り機能
- 検索履歴

## ライセンス

このプロジェクトはMITライセンスの下で公開されています。

## 貢献

バグ報告や機能要望は、GitHubのIssueでお知らせください。

## サポート

質問や問題がある場合は、以下のリソースを確認してください：
1. このREADME
2. `ref/specification.md` (詳細仕様書)
3. テストスクリプトの出力
4. ログファイル (`logs/bot.log`)

---

🚀 **実装完了**: Phase 1-3の全機能が動作確認済みです！

## 新機能のハイライト

### 🎯 検索結果選択メニュー
複数の検索結果が見つかった場合、ドロップダウンメニューから直接アイテムを選択できます。

### 🔗 関連アイテム連携
- 「🔗 関連アイテム」ボタンで素材・制作物・ドロップ情報を表示
- 関連アイテムをクリックして詳細情報にジャンプ

### 🎨 強化されたUX
- ボタン処理中の無効化で重複実行を防止
- より分かりやすいエラーメッセージ
- 検索候補の自動提示

### ⚡ 高速検索
- 関連性スコアによる結果ソート
- 前方一致優先の効率的な検索アルゴリズム
