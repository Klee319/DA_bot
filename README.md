# Discord アイテム参照BOT

ゲーム内アイテム情報を検索・表示するDiscord BOTです。装備、素材、モンスター、採集場所、NPCの情報を一元管理し、インタラクティブな検索機能を提供します。

## 主な機能

### 🔍 検索機能
- **アイテム検索**: メッセージ入力で自動検索（装備/素材/モンスター/NPC）
- **複数検索**: 最大3アイテムを同時検索
- **あいまい検索**: ひらがな⇔カタカナ、部分一致対応
- **場所×入手手段検索**: 場所と入手方法の組み合わせ検索

### 🎯 インタラクティブ機能
- **プルダウンメニュー**: 
  - NPCの取引詳細
  - モブのドロップアイテム
  - 装備の必要素材
  - 採集場所の入手可能素材
- **ボタン操作**:
  - 入手元詳細（素材・装備）
  - 利用先詳細（素材）
  - ページネーション

### 📊 ユーザー機能
- **お気に入り登録**: アイテムをお気に入りに保存
- **検索履歴**: 過去30日間の検索履歴を表示
- **画像表示**: アイテム画像のサムネイル表示

### 🛠️ 管理者機能
- **CSVアップロード**: データの一括更新
- **検索統計**: 人気検索ワードの表示

## セットアップ

### 1. 必要な環境
- Python 3.10以上
- Discord Bot トークン
- 必要な権限: メッセージ送信、埋め込みリンク、ファイル添付

### 2. インストール
```bash
# リポジトリのクローン
git clone [repository-url]
cd DA_discord

# 依存関係のインストール
pip install -r requirements.txt
```

### 3. 環境設定
`.env`ファイルを作成:
```env
DISCORD_TOKEN=your_bot_token_here
ADMIN_USER_IDS=123456789012345678,987654321098765432
LOG_CHANNEL_ID=123456789012345678
```

### 4. 起動
```bash
python src/main.py
```

## 使い方

### 基本的な検索
```
ウッドソード        # アイテム名で検索
木の棒 鉄の棒       # 複数アイテム検索
モブ レポロ        # 場所×入手手段検索
```

### スラッシュコマンド

#### 管理者用コマンド
- `/upload_csv` - CSVファイルでデータ更新
- `/stats` - 検索統計を表示
- `/add_admin_role` - 管理者ロールを追加
- `/remove_admin_role` - 管理者ロールを削除
- `/add_allowed_channel` - BOT利用可能チャンネルを追加
- `/remove_allowed_channel` - BOT利用可能チャンネルを削除
- `/list_permissions` - 現在の権限設定を表示

### 通常コマンド
- `!favorites` / `!fav` - お気に入り一覧
- `!history` - 検索履歴

### チャンネル制限について
このBOTはホワイトリスト制で動作します。BOTを使用するには、管理者が `/add_allowed_channel` コマンドで利用可能なチャンネルを明示的に追加する必要があります。

## データベース構造

### 実装済みテーブル
| テーブル名 | 説明 | 主要カラム |
|------------|------|------------|
| equipments | 装備アイテム | formal_name, required_materials, image_url |
| materials | 素材アイテム | formal_name, acquisition_method, usage_purpose |
| mobs | モンスター | formal_name, required_level, drops |
| gatherings | 採集場所 | location, collection_method, obtained_materials |
| npcs | NPC情報 | name, business_type, obtainable_items |

### CSV形式

#### 装備 (equipments)
```csv
正式名称,一般名称,入手場所,入手カテゴリ,種類,必要素材,アイテム効果,一言,画像リンク
```

#### 素材 (materials)
```csv
正式名称,一般名称,入手カテゴリ,入手方法,利用カテゴリ,使用用途,一言,画像リンク
```

#### モンスター (mobs)
```csv
正式名称,一般名称,出没エリア,出没エリア詳細,必要レベル,ドロップ品,EXP,Gold,必要防御力,一言,画像リンク
```

#### 採集 (gatherings)
```csv
場所,収集方法,入手素材,必要ツール,一言
```

#### NPC (npcs)
```csv
場所,NPC名,業種,入手アイテム,必要素材,EXP,Gold,一言,画像パス
```

## 技術仕様

### 使用技術
- **言語**: Python 3.10+
- **フレームワーク**: discord.py 2.3.x
- **データベース**: SQLite3
- **主要ライブラリ**:
  - pandas: CSV処理
  - jaconv: 日本語変換
  - aiohttp: 非同期HTTP
  - aiosqlite: 非同期DB操作

### アーキテクチャ
```
src/
├── main.py           # BOT本体
├── database.py       # DB管理
├── search_engine.py  # 検索エンジン
├── embed_manager.py  # 表示管理
├── csv_manager.py    # CSV処理
└── npc_parser.py     # NPC解析
```

### 特徴的な実装
- **非同期処理**: 全DB操作を非同期化
- **インデント統一**: ゼロ幅スペース使用
- **エラーハンドリング**: ユーザーフレンドリーなメッセージ
- **メモリ効率**: ページネーションによる分割表示

## トラブルシューティング

### BOTが応答しない
1. トークンが正しく設定されているか確認
2. BOTに必要な権限があるか確認
3. `logs/bot.log`でエラーを確認

### 検索結果が表示されない
1. データベースにデータが存在するか確認
2. 検索ワードの表記を確認（ひらがな/カタカナ）

### CSVアップロードエラー
1. CSV形式が仕様と一致しているか確認
2. 文字コードがUTF-8か確認
3. 必須カラムが存在するか確認

## 開発者向け情報

### コントリビューション
1. Issueで機能提案・バグ報告
2. Pull Requestは`develop`ブランチへ
3. コミットメッセージは日本語可

### テスト実行
```bash
python test_bot.py
```

### ログ確認
- 実行ログ: `logs/bot.log`
- エラーログ: `logs/error.log`
- CSVログ: `logs/csv_import.log`

## ライセンス

MIT License

## 更新履歴

### 最新版の主な変更点
- NPCテーブルの実装完了
- プルダウンメニューの全面採用
- embedインデントの統一
- 利用先詳細ボタンの復活
- ※記号の削除によるUI簡素化

---

📝 **注意**: このBOTは特定のゲーム向けに開発されています。使用する際は対象ゲームの利用規約を確認してください。